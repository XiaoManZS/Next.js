---
import Layout from "./Layout.astro";
import { tutorialSections } from "../config/tutorials";

export interface Props {
    title: string;
    description?: string;
}

const { title, description } = Astro.props;
---

<Layout title={title} description={description}>
    <div class="tutorials-container">
        <!-- 左侧菜单 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>学习指南</h2>
            </div>

            <nav class="sidebar-nav">
                {tutorialSections.map((section) => (
                    <div class="nav-section">
                        <h3 class="nav-title">{section.title}</h3>
                        <ul class="nav-links">
                            {section.items.map((item) => (
                                <li>
                                    <a href={item.path}>{item.title}</a>
                                </li>
                            ))}
                        </ul>
                    </div>
                ))}
            </nav>
        </aside>

        <!-- 右侧内容 -->
        <main class="tutorial-content">
            <slot />
        </main>
    </div>
</Layout>

<style>
    .tutorials-container {
        display: flex;
        gap: 0;
        min-height: calc(100vh - 200px);
        margin: -4rem -2rem 0;
    }

    /* 左侧边栏 */
    .sidebar {
        width: 300px;
        background: transparent;
        border-right: 1px solid var(--border-color);
        position: sticky;
        top: 70px;
        height: calc(100vh - 70px);
        overflow-x: hidden;
        overflow-y: auto;
        flex-shrink: 0;
        padding: 2rem 0 2rem 2rem;
        box-sizing: border-box;
    }

    .sidebar-header {
        padding: 0 1.5rem 1rem;
        margin-bottom: 1rem;
    }

    .sidebar-header h2 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .sidebar-nav {
        padding: 1rem 0;
    }

    .nav-section {
        margin-bottom: 1.5rem;
    }

    .nav-title {
        padding: 0.75rem 1.5rem 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .nav-links {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
    }

    .nav-links li {
        display: block;
        width: 100%;
    }

    .nav-links li a {
        display: block;
        width: 100%;
        padding: 0.4rem 1.5rem 0.4rem 2rem;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        border-left: 2px solid transparent;
        margin-left: 1rem;
    }

    .nav-links li a:hover {
        color: var(--text-primary);
        background: rgba(255, 255, 255, 0.03);
    }

  .nav-links li a.active {
    color: var(--text-primary);
    border-left-color: var(--primary);
    background: rgba(255, 255, 255, 0.05);
  }

    /* 右侧内容 */
    .tutorial-content {
        flex: 1;
        padding: 2rem 4rem 4rem 3rem;
        overflow-y: auto;
        max-width: 1000px;
    }

    /* 滚动条样式 */
    .sidebar::-webkit-scrollbar,
    .tutorial-content::-webkit-scrollbar {
        width: 6px;
    }

    .sidebar::-webkit-scrollbar-track,
    .tutorial-content::-webkit-scrollbar-track {
        background: transparent;
    }

    .sidebar::-webkit-scrollbar-thumb,
    .tutorial-content::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover,
    .tutorial-content::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    /* 响应式设计 */
    @media (max-width: 1200px) {
        .sidebar {
            width: 260px;
        }

        .tutorial-content {
            padding: 2rem 3rem 4rem 2rem;
        }
    }

    @media (max-width: 1024px) {
        .tutorials-container {
            margin: -3rem -1.5rem 0;
        }

        .sidebar {
            width: 240px;
            padding: 2rem 0 2rem 1.5rem;
        }

        .tutorial-content {
            padding: 2rem 2rem 4rem 2rem;
        }
    }

    @media (max-width: 768px) {
        .tutorials-container {
            flex-direction: column;
        }

        .sidebar {
            width: 100%;
            height: auto;
            border-right: none;
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem;
            box-sizing: border-box;
        }

        .sidebar-header {
            padding: 0 0 1rem;
            box-sizing: border-box;
        }

        .tutorial-content {
            padding: 2rem 1.5rem;
            box-sizing: border-box;
    }
  }
</style>

<style is:global>
    /* Markdown 内容样式 */
    .tutorial-content h1 {
        font-size: clamp(2.5rem, 5vw, 3rem);
        font-weight: 800;
        color: var(--text-primary);
        margin: 0 0 2rem 0;
        letter-spacing: -0.02em;
        line-height: 1.2;
    }

    .tutorial-content h2 {
        font-size: clamp(1.75rem, 4vw, 2rem);
        font-weight: 700;
        color: var(--text-primary);
        margin: 3rem 0 1.5rem 0;
        padding-left: 1rem;
        border-left: 4px solid var(--primary);
        line-height: 1.3;
    }

    .tutorial-content h3 {
        font-size: clamp(1.35rem, 3vw, 1.5rem);
        font-weight: 600;
        color: var(--text-primary);
        margin: 2.5rem 0 1rem 0;
        line-height: 1.4;
    }

    .tutorial-content h4 {
        font-size: 1.15rem;
        font-weight: 600;
        color: var(--text-secondary);
        margin: 2rem 0 1rem 0;
        line-height: 1.4;
    }

    .tutorial-content p {
        font-size: 1.05rem;
        line-height: 1.8;
        color: var(--text-secondary);
        margin: 0 0 1.5rem 0;
    }

    .tutorial-content a {
        color: #007bff;
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: all 0.2s ease;
    }

    .tutorial-content a:hover {
        border-bottom-color: #007bff;
    }

    .tutorial-content strong {
        color: var(--text-primary);
        font-weight: 600;
    }

    .tutorial-content em {
        font-style: italic;
        color: var(--text-secondary);
    }

    .tutorial-content code {
        background: rgba(101, 117, 133, .16);
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-family: 'Courier New', Consolas, Monaco, monospace;
        font-size: 0.9em;
        color: #a8b1ff;
    }

    .tutorial-content pre {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        overflow-x: auto;
        position: relative;
    }

    /* 代码块横向滚动条样式 */
    .tutorial-content pre::-webkit-scrollbar {
        height: 8px;
    }

    .tutorial-content pre::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
        margin: 0 0.5rem;
    }

    .tutorial-content pre::-webkit-scrollbar-thumb {
        background: linear-gradient(90deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
        border-radius: 4px;
        border: 2px solid rgba(0, 0, 0, 0.4);
        transition: background 0.3s ease;
    }

    .tutorial-content pre::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(90deg, rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.4));
    }

    .tutorial-content pre::-webkit-scrollbar-thumb:active {
        background: linear-gradient(90deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.5));
    }

    /* Firefox 滚动条样式 */
    .tutorial-content pre {
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.05);
    }

    .tutorial-content pre code {
        background: none;
        padding: 0;
        border: none;
        font-size: 0.9rem;
        line-height: 1.6;
        color: var(--text-secondary);
    }

    .tutorial-content ul,
    .tutorial-content ol {
        margin: 1.5rem 0;
        padding-left: 2rem;
        line-height: 1.8;
    }

    .tutorial-content ul {
        list-style: none;
    }

    .tutorial-content ul > li {
        position: relative;
        margin-bottom: 0.75rem;
        color: var(--text-secondary);
    }

    .tutorial-content ul > li::before {
        content: '';
        position: absolute;
        left: -1.5rem;
        top: 0.6em;
        width: 6px;
        height: 6px;
        background: var(--primary);
        border-radius: 50%;
    }

    .tutorial-content ol {
        list-style: decimal;
        list-style-position: outside;
    }

    .tutorial-content ol > li {
        margin-bottom: 0.75rem;
        color: var(--text-secondary);
        padding-left: 0.5rem;
    }

    .tutorial-content ol > li::marker {
        color: var(--primary);
        font-weight: 600;
    }

    .tutorial-content blockquote {
        margin: 2rem 0;
        padding: 1rem 1.5rem;
        background: rgba(255, 255, 255, 0.03);
        border-left: 4px solid var(--primary);
        border-radius: 4px;
    }

    .tutorial-content blockquote p {
        margin: 0.5rem 0;
        color: var(--text-secondary);
    }

    .tutorial-content blockquote p:first-child {
        margin-top: 0;
    }

    .tutorial-content blockquote p:last-child {
        margin-bottom: 0;
    }

    .tutorial-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 2rem 0;
        font-size: 0.95rem;
    }

    .tutorial-content table th,
    .tutorial-content table td {
        padding: 0.75rem 1rem;
        text-align: left;
        border: 1px solid var(--border-color);
    }

    .tutorial-content table th {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-primary);
        font-weight: 600;
    }

    .tutorial-content table td {
        color: var(--text-secondary);
    }

    .tutorial-content table tr:hover td {
        background: rgba(255, 255, 255, 0.02);
    }

    .tutorial-content hr {
        border: none;
        border-top: 1px solid var(--border-color);
        margin: 3rem 0;
    }

    .tutorial-content img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 2rem 0;
        border: 1px solid var(--border-color);
    }

    /* 特殊元素 - details/summary */
    .tutorial-content details {
        margin: 1.5rem 0;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-color);
        border-radius: 8px;
    }

    .tutorial-content summary {
        cursor: pointer;
        font-weight: 600;
        color: var(--text-primary);
        user-select: none;
        padding: 0.5rem;
        margin: -0.5rem;
        border-radius: 4px;
        transition: background 0.2s ease;
    }

    .tutorial-content summary:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .tutorial-content details[open] summary {
        margin-bottom: 1rem;
    }

    /* 代码块复制按钮 */
    .copy-code-button {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        padding: 0.5rem 0.75rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: var(--text-primary);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.4rem;
        opacity: 0;
        z-index: 10;
    }

    .tutorial-content pre:hover .copy-code-button {
        opacity: 1;
    }

    .copy-code-button:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
    }

    .copy-code-button:active {
        transform: translateY(0);
    }

    .copy-code-button.copied {
        background: rgba(16, 185, 129, 0.2);
        border-color: rgba(16, 185, 129, 0.4);
        color: #10b981;
    }

    .copy-code-button svg {
        width: 16px;
        height: 16px;
    }

    /* 响应式 */
    @media (max-width: 768px) {
        .tutorial-content h1 {
            font-size: 2rem;
            margin-bottom: 1.5rem;
        }

        .tutorial-content h2 {
            font-size: 1.5rem;
            margin-top: 2rem;
        }

        .tutorial-content h3 {
            font-size: 1.25rem;
        }

        .tutorial-content p,
        .tutorial-content li {
            font-size: 1rem;
        }

        .tutorial-content pre {
            padding: 1rem;
            font-size: 0.85rem;
        }

        .tutorial-content table {
            font-size: 0.875rem;
        }

        .tutorial-content table th,
        .tutorial-content table td {
            padding: 0.5rem;
        }

        .copy-code-button {
            opacity: 1;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.4rem 0.6rem;
            font-size: 0.75rem;
        }
    }
</style>

<script>
  // 高亮当前页面对应的菜单项
  function highlightCurrentPage() {
    const currentPath = window.location.pathname;
    const links = document.querySelectorAll('.nav-links a');
    
    links.forEach(link => {
      const linkPath = link.getAttribute('href');
      if (linkPath === currentPath) {
        link.classList.add('active');
      } else {
        link.classList.remove('active');
      }
    });
  }

  // 页面加载时执行
  highlightCurrentPage();

  // 监听导航事件（如果使用了客户端路由）
  document.addEventListener('astro:page-load', highlightCurrentPage);

  // 为代码块添加复制按钮
  function addCopyButtons() {
    const codeBlocks = document.querySelectorAll('.tutorial-content pre');
    
    codeBlocks.forEach((pre) => {
      // 避免重复添加按钮
      if (pre.querySelector('.copy-code-button')) {
        return;
      }

      const button = document.createElement('button');
      button.className = 'copy-code-button';
      button.setAttribute('aria-label', '复制代码');
      
      // SVG 图标
      const copyIcon = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
        <span>复制</span>
      `;
      
      const checkIcon = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <span>已复制</span>
      `;
      
      button.innerHTML = copyIcon;
      
      button.addEventListener('click', async () => {
        const code = pre.querySelector('code');
        const text = code?.textContent || '';
        
        try {
          await navigator.clipboard.writeText(text);
          
          // 显示成功状态
          button.innerHTML = checkIcon;
          button.classList.add('copied');
          
          // 2 秒后恢复原状
          setTimeout(() => {
            button.innerHTML = copyIcon;
            button.classList.remove('copied');
          }, 2000);
        } catch (err) {
          console.error('复制失败:', err);
          
          // 降级方案：使用 execCommand
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          
          try {
            document.execCommand('copy');
            button.innerHTML = checkIcon;
            button.classList.add('copied');
            
            setTimeout(() => {
              button.innerHTML = copyIcon;
              button.classList.remove('copied');
            }, 2000);
          } catch (err2) {
            console.error('降级复制也失败:', err2);
          }
          
          document.body.removeChild(textarea);
        }
      });
      
      pre.appendChild(button);
    });
  }

  // 页面加载时添加复制按钮
  addCopyButtons();

  // 监听页面导航
  document.addEventListener('astro:page-load', addCopyButtons);
</script>
