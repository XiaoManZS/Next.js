---
import Layout from "./Layout.astro";
import { tutorialSections } from "../config/tutorials";

export interface Props {
    title: string;
    description?: string;
}

const { title, description } = Astro.props;
---

<Layout title={title} description={description}>
    <div class="tutorials-container">
        <!-- 左侧菜单 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>学习指南</h2>
            </div>

            <nav class="sidebar-nav">
                {tutorialSections.map((section) => (
                    <div class="nav-section">
                        <h3 class="nav-title">{section.title}</h3>
                        <ul class="nav-links">
                            {section.items.map((item) => (
                                <li>
                                    <a href={item.path}>{item.title}</a>
                                </li>
                            ))}
                        </ul>
                    </div>
                ))}
            </nav>
        </aside>
        
        <!-- 立即恢复侧边栏滚动位置，避免闪烁 -->
        <script is:inline>
            (function() {
                const sidebar = document.querySelector('.sidebar');
                const savedScroll = sessionStorage.getItem('tutorial-sidebar-scroll');
                if (sidebar && savedScroll) {
                    sidebar.scrollTop = parseInt(savedScroll, 10);
                }
            })();
        </script>

        <!-- 中间内容 -->
        <main class="tutorial-content">
            <slot />
        </main>
    </div>

        <!-- 右侧目录（固定定位） -->
        <aside class="toc-sidebar">
            <div class="toc-header">
                <h2>本页目录</h2>
            </div>
            <nav class="toc-nav" id="toc-nav">
                <!-- 目录将通过 JavaScript 动态生成 -->
            </nav>
        </aside>
</Layout>

<style>
    .tutorials-container {
        display: flex;
        gap: 0;
        min-height: calc(100vh - 200px);
        margin: -4rem -2rem 0;
    }

    /* 左侧边栏 */
    .sidebar {
        width: 300px;
        background: transparent;
        border-right: 1px solid var(--border-color);
        position: sticky;
        top: 70px;
        height: calc(100vh - 70px);
        overflow-x: hidden;
        overflow-y: auto;
        flex-shrink: 0;
        padding: 2rem 0 2rem 2rem;
        box-sizing: border-box;
    }

    .sidebar-header {
        padding: 0 1.5rem 1rem;
        margin-bottom: 1rem;
    }

    .sidebar-header h2 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .sidebar-nav {
        padding: 1rem 0;
    }

    .nav-section {
        margin-bottom: 1.5rem;
    }

    .nav-title {
        padding: 0.75rem 1.5rem 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .nav-links {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
    }

    .nav-links li {
        display: block;
        width: 100%;
    }

    .nav-links li a {
        display: block;
        width: 100%;
        padding: 0.4rem 1.5rem 0.4rem 2rem;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        border-left: 2px solid transparent;
        margin-left: 1rem;
    }

    .nav-links li a:hover {
        color: var(--text-primary);
        background: rgba(255, 255, 255, 0.03);
    }

  .nav-links li a.active {
    color: var(--text-primary);
    border-left-color: var(--primary);
    background: rgba(255, 255, 255, 0.05);
  }

    /* 中间内容 */
    .tutorial-content {
        flex: 1;
        padding: 2rem 4rem 4rem 3rem;
        overflow-y: auto;
        max-width: 1000px;
    }

    /* 右侧目录（固定定位） */
    .toc-sidebar {
        position: fixed;
        right: 2rem;
        top: 120px;
        width: 200px;
        max-height: calc(100vh - 160px);
        overflow-y: auto;
        padding: 0;
        box-sizing: border-box;
        z-index: 10;
    }

    .toc-header {
        padding: 0 0 0.75rem 1rem;
        margin-bottom: 0.5rem;
    }

    .toc-header h2 {
        font-size: 0.8rem;
        font-weight: 600;
        color: rgba(209, 213, 219, 0.95);
        margin: 0;
        letter-spacing: 0;
    }

    .toc-nav {
        padding: 0;
    }

    .toc-nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
        border-left: 1px solid rgba(156, 163, 175, 0.2);
    }

    .toc-nav li {
        margin: 0;
    }

    .toc-nav .toc-link {
        display: block;
        padding: 0.4rem 0 0.4rem 1rem;
        color: rgba(156, 163, 175, 0.9);
        font-size: 0.8rem;
        line-height: 1.5;
        transition: all 0.2s ease;
        border-left: 2px solid transparent;
        margin-left: -1px;
        cursor: pointer;
    }

    /* 子标题样式 */
    .toc-nav .toc-link.toc-h3 {
        padding-left: 2rem;
        font-size: 0.75rem;
        color: rgba(156, 163, 175, 0.8);
    }

    .toc-nav .toc-link:hover {
        color: rgba(255, 255, 255, 0.95);
    }

    .toc-nav .toc-link.active {
        color: #60a5fa;
        border-left-color: #60a5fa;
        font-weight: 500;
    }

    /* 目录滚动条样式 */
    .toc-sidebar::-webkit-scrollbar {
        width: 4px;
    }

    .toc-sidebar::-webkit-scrollbar-track {
        background: transparent;
    }

    .toc-sidebar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 2px;
    }

    .toc-sidebar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.25);
    }

    /* 滚动条样式 */
    .sidebar::-webkit-scrollbar,
    .tutorial-content::-webkit-scrollbar,
    .toc-sidebar::-webkit-scrollbar {
        width: 6px;
    }

    .sidebar::-webkit-scrollbar-track,
    .tutorial-content::-webkit-scrollbar-track,
    .toc-sidebar::-webkit-scrollbar-track {
        background: transparent;
    }

    .sidebar::-webkit-scrollbar-thumb,
    .tutorial-content::-webkit-scrollbar-thumb,
    .toc-sidebar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover,
    .tutorial-content::-webkit-scrollbar-thumb:hover,
    .toc-sidebar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    /* 响应式设计 */
    @media (max-width: 1600px) {
        .toc-sidebar {
            right: 1.5rem;
        }
    }

    @media (max-width: 1400px) {
        .toc-sidebar {
            width: 180px;
            right: 1rem;
        }

        .toc-nav .toc-link {
            font-size: 0.75rem;
            padding: 0.35rem 0 0.35rem 1rem;
        }
        
        .toc-nav .toc-link.toc-h3 {
            padding-left: 1.75rem;
        }
    }

    @media (max-width: 1200px) {
        .sidebar {
            width: 260px;
        }

        .tutorial-content {
            padding: 2rem 3rem 4rem 2rem;
        }

        .toc-sidebar {
            display: none;
        }
    }

    @media (max-width: 1024px) {
        .tutorials-container {
            margin: -3rem -1.5rem 0;
        }

        .sidebar {
            width: 240px;
            padding: 2rem 0 2rem 1.5rem;
        }

        .tutorial-content {
            padding: 2rem 2rem 4rem 2rem;
        }
    }

    @media (max-width: 768px) {
        .tutorials-container {
            flex-direction: column;
        }

        .sidebar {
            width: 100%;
            height: auto;
            border-right: none;
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem;
            box-sizing: border-box;
        }

        .sidebar-header {
            padding: 0 0 1rem;
            box-sizing: border-box;
        }

        .tutorial-content {
            padding: 2rem 1.5rem;
            box-sizing: border-box;
        }
    }
</style>

<style is:global>
    /* Markdown 内容样式 */
    .tutorial-content h1 {
        font-size: clamp(2.5rem, 5vw, 3rem);
        font-weight: 800;
        color: var(--text-primary);
        margin: 0 0 2rem 0;
        letter-spacing: -0.02em;
        line-height: 1.2;
    }

    .tutorial-content h2 {
        font-size: clamp(1.75rem, 4vw, 2rem);
        font-weight: 700;
        color: var(--text-primary);
        margin: 3rem 0 1.5rem 0;
        padding-left: 1rem;
        border-left: 4px solid var(--primary);
        line-height: 1.3;
    }

    .tutorial-content h3 {
        font-size: clamp(1.35rem, 3vw, 1.5rem);
        font-weight: 600;
        color: var(--text-primary);
        margin: 2.5rem 0 1rem 0;
        line-height: 1.4;
    }

    .tutorial-content h4 {
        font-size: 1.15rem;
        font-weight: 600;
        color: var(--text-secondary);
        margin: 2rem 0 1rem 0;
        line-height: 1.4;
    }

    .tutorial-content p {
        font-size: 1.05rem;
        line-height: 1.8;
        color: var(--text-secondary);
        margin: 0 0 1.5rem 0;
    }

    .tutorial-content a {
        color: #007bff;
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: all 0.2s ease;
    }

    .tutorial-content a:hover {
        border-bottom-color: #007bff;
    }

    .tutorial-content strong {
        color: var(--text-primary);
        font-weight: 600;
    }

    .tutorial-content em {
        font-style: italic;
        color: var(--text-secondary);
    }

    .tutorial-content code {
        background: rgba(101, 117, 133, .16);
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-family: 'Courier New', Consolas, Monaco, monospace;
        font-size: 0.9em;
        color: #a8b1ff;
    }

    .tutorial-content pre {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        overflow-x: auto;
        position: relative;
    }

    /* 代码块横向滚动条样式 */
    .tutorial-content pre::-webkit-scrollbar {
        height: 8px;
    }

    .tutorial-content pre::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
        margin: 0 0.5rem;
    }

    .tutorial-content pre::-webkit-scrollbar-thumb {
        background: linear-gradient(90deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
        border-radius: 4px;
        border: 2px solid rgba(0, 0, 0, 0.4);
        transition: background 0.3s ease;
    }

    .tutorial-content pre::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(90deg, rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.4));
    }

    .tutorial-content pre::-webkit-scrollbar-thumb:active {
        background: linear-gradient(90deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.5));
    }

    /* Firefox 滚动条样式 */
    .tutorial-content pre {
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.05);
    }

    .tutorial-content pre code {
        background: none;
        padding: 0;
        border: none;
        font-size: 0.9rem;
        line-height: 1.6;
        color: var(--text-secondary);
    }

    .tutorial-content ul,
    .tutorial-content ol {
        margin: 1.5rem 0;
        padding-left: 2rem;
        line-height: 1.8;
    }

    .tutorial-content ul {
        list-style: none;
    }

    .tutorial-content ul > li {
        position: relative;
        margin-bottom: 0.75rem;
        color: var(--text-secondary);
    }

    .tutorial-content ul > li::before {
        content: '';
        position: absolute;
        left: -1.5rem;
        top: 0.6em;
        width: 6px;
        height: 6px;
        background: var(--primary);
        border-radius: 50%;
    }

    .tutorial-content ol {
        list-style: decimal;
        list-style-position: outside;
    }

    .tutorial-content ol > li {
        margin-bottom: 0.75rem;
        color: var(--text-secondary);
        padding-left: 0.5rem;
    }

    .tutorial-content ol > li::marker {
        color: var(--primary);
        font-weight: 600;
    }

    .tutorial-content blockquote {
        margin: 2rem 0;
        padding: 1rem 1.5rem;
        background: rgba(255, 255, 255, 0.03);
        border-left: 4px solid var(--primary);
        border-radius: 4px;
    }

    .tutorial-content blockquote p {
        margin: 0.5rem 0;
        color: var(--text-secondary);
    }

    .tutorial-content blockquote p:first-child {
        margin-top: 0;
    }

    .tutorial-content blockquote p:last-child {
        margin-bottom: 0;
    }

    .tutorial-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 2rem 0;
        font-size: 0.95rem;
    }

    .tutorial-content table th,
    .tutorial-content table td {
        padding: 0.75rem 1rem;
        text-align: left;
        border: 1px solid var(--border-color);
    }

    .tutorial-content table th {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-primary);
        font-weight: 600;
    }

    .tutorial-content table td {
        color: var(--text-secondary);
    }

    .tutorial-content table tr:hover td {
        background: rgba(255, 255, 255, 0.02);
    }

    .tutorial-content hr {
        border: none;
        border-top: 1px solid var(--border-color);
        margin: 3rem 0;
    }

    .tutorial-content img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 2rem 0;
        border: 1px solid var(--border-color);
    }

    /* 特殊元素 - details/summary */
    .tutorial-content details {
        margin: 1.5rem 0;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-color);
        border-radius: 8px;
    }

    .tutorial-content summary {
        cursor: pointer;
        font-weight: 600;
        color: var(--text-primary);
        user-select: none;
        padding: 0.5rem;
        margin: -0.5rem;
        border-radius: 4px;
        transition: background 0.2s ease;
    }

    .tutorial-content summary:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .tutorial-content details[open] summary {
        margin-bottom: 1rem;
    }

    /* 代码块复制按钮 */
    .copy-code-button {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        padding: 0.5rem 0.75rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        color: var(--text-primary);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.4rem;
        opacity: 0;
        z-index: 10;
    }

    .tutorial-content pre:hover .copy-code-button {
        opacity: 1;
    }

    .copy-code-button:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
    }

    .copy-code-button:active {
        transform: translateY(0);
    }

    .copy-code-button.copied {
        background: rgba(16, 185, 129, 0.2);
        border-color: rgba(16, 185, 129, 0.4);
        color: #10b981;
    }

    .copy-code-button svg {
        width: 16px;
        height: 16px;
    }

    /* Mermaid 图表容器样式 */
    .tutorial-content .mermaid-container {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 12px;
        padding: 2.5rem;
        margin: 2rem 0;
        overflow-x: auto;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .tutorial-content .mermaid-container svg {
        max-width: 100%;
        height: auto;
        border: none;
        margin: 0;
    }

    /* Mermaid 图表文本样式优化 - 确保文字清晰可见 */
    .tutorial-content .mermaid-container .nodeLabel,
    .tutorial-content .mermaid-container .edgeLabel,
    .tutorial-content .mermaid-container text,
    .tutorial-content .mermaid-container span {
        fill: #ffffff !important;
        color: #ffffff !important;
        font-weight: 500 !important;
        font-size: 15px !important;
        letter-spacing: 0.2px !important;
    }

    /* 确保节点边框清晰 */
    .tutorial-content .mermaid-container .node rect,
    .tutorial-content .mermaid-container .node circle,
    .tutorial-content .mermaid-container .node polygon,
    .tutorial-content .mermaid-container .node path {
        stroke-width: 2px !important;
    }
    
    /* 强制所有节点使用深色背景 */
    .tutorial-content .mermaid-container .node .label {
        color: #ffffff !important;
    }
    
    /* 箭头和连线样式 */
    .tutorial-content .mermaid-container .edgePath path {
        stroke-width: 2px !important;
        stroke: #94a3b8 !important;
    }
    
    .tutorial-content .mermaid-container .arrowheadPath {
        fill: #cbd5e1 !important;
        stroke: #cbd5e1 !important;
    }

    /* Mermaid 滚动条样式 */
    .tutorial-content .mermaid-container::-webkit-scrollbar {
        height: 8px;
    }

    .tutorial-content .mermaid-container::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
    }

    .tutorial-content .mermaid-container::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        border: 2px solid rgba(0, 0, 0, 0.3);
    }

    .tutorial-content .mermaid-container::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.4);
    }

    /* 响应式 */
    @media (max-width: 768px) {
        .tutorial-content h1 {
            font-size: 2rem;
            margin-bottom: 1.5rem;
        }

        .tutorial-content h2 {
            font-size: 1.5rem;
            margin-top: 2rem;
        }

        .tutorial-content h3 {
            font-size: 1.25rem;
        }

        .tutorial-content p,
        .tutorial-content li {
            font-size: 1rem;
        }

        .tutorial-content pre {
            padding: 1rem;
            font-size: 0.85rem;
        }

        .tutorial-content table {
            font-size: 0.875rem;
        }

        .tutorial-content table th,
        .tutorial-content table td {
            padding: 0.5rem;
        }

        .copy-code-button {
            opacity: 1;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.4rem 0.6rem;
            font-size: 0.75rem;
        }

        .tutorial-content .mermaid-container {
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .tutorial-content .mermaid-container .nodeLabel,
        .tutorial-content .mermaid-container .edgeLabel,
        .tutorial-content .mermaid-container text,
        .tutorial-content .mermaid-container span {
            font-size: 13px !important;
            font-weight: 500 !important;
        }
    }
</style>

<script>
  // @ts-nocheck
  // 保存侧边栏滚动位置
  function saveSidebarScroll() {
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
      sessionStorage.setItem('tutorial-sidebar-scroll', sidebar.scrollTop.toString());
    }
  }
  
  // 在点击导航链接时保存滚动位置
  function attachScrollSaveHandlers() {
    const navLinks = document.querySelectorAll('.nav-links a');
    navLinks.forEach(link => {
      link.addEventListener('click', saveSidebarScroll);
    });
  }
  
  // 高亮当前页面对应的菜单项
  function highlightCurrentPage() {
    const currentPath = window.location.pathname;
    const links = document.querySelectorAll('.nav-links a');
    
    links.forEach(link => {
      const linkPath = link.getAttribute('href');
      if (linkPath === currentPath) {
        link.classList.add('active');
      } else {
        link.classList.remove('active');
      }
    });
  }

  // 页面加载时执行
  highlightCurrentPage();
  attachScrollSaveHandlers();

  // 监听导航事件（如果使用了客户端路由）
  document.addEventListener('astro:page-load', () => {
    highlightCurrentPage();
    attachScrollSaveHandlers();
  });

  // 为代码块添加复制按钮
  function addCopyButtons() {
    const codeBlocks = document.querySelectorAll('.tutorial-content pre');
    
    codeBlocks.forEach((pre) => {
      // 跳过 Mermaid 容器
      if (pre.hasAttribute('data-mermaid-pre')) {
        return;
      }
      
      // 避免重复添加按钮
      if (pre.querySelector('.copy-code-button')) {
        return;
      }

      const button = document.createElement('button');
      button.className = 'copy-code-button';
      button.setAttribute('aria-label', '复制代码');
      
      // SVG 图标
      const copyIcon = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
        <span>复制</span>
      `;
      
      const checkIcon = `
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <span>已复制</span>
      `;
      
      button.innerHTML = copyIcon;
      
      button.addEventListener('click', async () => {
        const code = pre.querySelector('code');
        const text = code?.textContent || '';
        
        try {
          await navigator.clipboard.writeText(text);
          
          // 显示成功状态
          button.innerHTML = checkIcon;
          button.classList.add('copied');
          
          // 2 秒后恢复原状
          setTimeout(() => {
            button.innerHTML = copyIcon;
            button.classList.remove('copied');
          }, 2000);
        } catch (err) {
          console.error('复制失败:', err);
          
          // 降级方案：使用 execCommand
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          
          try {
            document.execCommand('copy');
            button.innerHTML = checkIcon;
            button.classList.add('copied');
            
            setTimeout(() => {
              button.innerHTML = copyIcon;
              button.classList.remove('copied');
            }, 2000);
          } catch (err2) {
            console.error('降级复制也失败:', err2);
          }
          
          document.body.removeChild(textarea);
        }
      });
      
      pre.appendChild(button);
    });
  }

  // 页面加载时添加复制按钮
  addCopyButtons();

  // 监听页面导航
  document.addEventListener('astro:page-load', addCopyButtons);

  // 初始化 Mermaid
  function initMermaid() {
    // 查找所有代码块
    const allCodeBlocks = document.querySelectorAll('.tutorial-content pre code');
    const mermaidBlocks: HTMLElement[] = [];
    
    // 检查代码块内容，识别 Mermaid 图表
    allCodeBlocks.forEach((code: HTMLElement) => {
      const content = code.textContent.trim();
      // Mermaid 图表通常以这些关键字开头
      const mermaidKeywords = ['graph', 'flowchart', 'sequenceDiagram', 'classDiagram', 
                                'stateDiagram', 'erDiagram', 'journey', 'gantt', 'pie'];
      
      const isMermaid = mermaidKeywords.some(keyword => content.startsWith(keyword));
      
      if (isMermaid) {
        mermaidBlocks.push(code);
      }
    });
    
    if (mermaidBlocks.length === 0) {
      return;
    }
    
    // 动态加载 Mermaid
    if (!window.mermaid) {
      const script = document.createElement('script');
      script.type = 'module';
      script.textContent = `
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
          startOnLoad: false,
          theme: 'base',
          themeVariables: {
            darkMode: true,
            background: '#0f172a',
            // 主要节点（蓝色边框）- 深色背景确保白色文字清晰
            primaryColor: '#1e3a5f',
            primaryTextColor: '#ffffff',
            primaryBorderColor: '#60a5fa',
            // 次要节点（绿色）- 深色背景
            secondaryColor: '#065f46',
            secondaryTextColor: '#ffffff',
            secondaryBorderColor: '#34d399',
            // 第三类节点（浅色）- 深色背景
            tertiaryColor: '#1e293b',
            tertiaryTextColor: '#ffffff',
            tertiaryBorderColor: '#94a3b8',
            // 第四类（青色）
            quaternaryColor: '#164e63',
            quaternaryTextColor: '#ffffff',
            quaternaryBorderColor: '#22d3ee',
            // 连线和箭头
            lineColor: '#94a3b8',
            arrowheadColor: '#cbd5e1',
            // 全局文字颜色
            textColor: '#ffffff',
            labelTextColor: '#ffffff',
            // 节点背景
            mainBkg: '#1e3a5f',
            secondBkg: '#065f46',
            tertiaryBkg: '#1e293b',
            // 边框
            nodeBorder: '#60a5fa',
            // 字体配置
            fontSize: '15px',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif'
          },
          flowchart: {
            curve: 'basis',
            padding: 25,
            useMaxWidth: true,
            htmlLabels: true
          }
        });
        window.mermaid = mermaid;
        window.dispatchEvent(new Event('mermaid-loaded'));
      `;
      document.head.appendChild(script);
    }
    
    // 等待 Mermaid 加载完成
    function renderMermaid() {
      mermaidBlocks.forEach((block, index) => {
        const pre = block.parentElement;
        if (!pre) return;
        
        const code = block.textContent;
        
        // 标记为 Mermaid pre，避免添加复制按钮
        pre.setAttribute('data-mermaid-pre', 'true');
        
        // 创建 Mermaid 容器
        const div = document.createElement('div');
        div.className = 'mermaid-container';
        div.textContent = code;
        
        // 替换代码块
        pre.replaceWith(div);
      });
      
      // 渲染所有 Mermaid 图表
      if (window.mermaid) {
        window.mermaid.run({
          querySelector: '.mermaid-container'
        });
      }
    }
    
    if (window.mermaid) {
      renderMermaid();
    } else {
      window.addEventListener('mermaid-loaded', renderMermaid, { once: true });
    }
  }

  // 页面加载时初始化（延迟执行确保 DOM 完全加载）
  setTimeout(initMermaid, 100);

  // 监听页面导航
  document.addEventListener('astro:page-load', () => {
    setTimeout(initMermaid, 100);
  });

  // 生成目录导航
  function generateTOC() {
    const tocNav = document.getElementById('toc-nav');
    if (!tocNav) return;

    // 查找所有标题（h2, h3）
    const headings = document.querySelectorAll('.tutorial-content h2, .tutorial-content h3');
    
    if (headings.length === 0) {
      tocNav.innerHTML = '<p style="padding: 0 1.5rem; color: var(--text-secondary); font-size: 0.75rem;">本页无目录</p>';
      return;
    }

    // 为标题添加 id（如果没有的话）
    headings.forEach((heading, index) => {
      if (!heading.id) {
        const text = heading.textContent || '';
        // 使用标题文本生成 id，移除特殊字符
        const id = text.trim().replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '-').toLowerCase() || `heading-${index}`;
        heading.id = id;
      }
    });

    // 生成目录 HTML
    const tocList = document.createElement('ul');
    
    headings.forEach((heading) => {
      const li = document.createElement('li');
      const link = document.createElement('span');
      
      link.setAttribute('data-target', heading.id);
      link.textContent = heading.textContent || '';
      link.classList.add('toc-link');
      
      // 设置基础样式
      link.style.display = 'block';
      link.style.color = 'rgba(156, 163, 175, 0.9)';
      link.style.fontSize = '0.8rem';
      link.style.lineHeight = '1.5';
      link.style.transition = 'all 0.2s ease';
      link.style.borderLeft = '2px solid transparent';
      link.style.marginLeft = '-1px';
      link.style.cursor = 'pointer';
      link.style.padding = '0.4rem 0 0.4rem 1rem';
      
      // 根据标题级别添加类名和样式
      if (heading.tagName === 'H3') {
        link.classList.add('toc-h3');
        link.style.paddingLeft = '2rem';
        link.style.fontSize = '0.75rem';
        link.style.color = 'rgba(156, 163, 175, 0.8)';
      }
      
      // 鼠标悬停事件
      link.addEventListener('mouseenter', () => {
        if (!link.classList.contains('active')) {
          link.style.color = 'rgba(255, 255, 255, 0.95)';
        }
      });
      
      link.addEventListener('mouseleave', () => {
        if (!link.classList.contains('active')) {
          if (heading.tagName === 'H3') {
            link.style.color = 'rgba(156, 163, 175, 0.8)';
          } else {
            link.style.color = 'rgba(156, 163, 175, 0.9)';
          }
        } else {
          link.style.color = '#60a5fa';
        }
      });
      
      // 点击事件：平滑滚动
      link.addEventListener('click', (e) => {
        const target = document.getElementById(heading.id);
        if (target) {
          // 计算滚动位置（减去固定头部的高度）
          const offset = 80;
          const targetPosition = target.getBoundingClientRect().top + window.pageYOffset - offset;
          
          window.scrollTo({
            top: targetPosition,
            behavior: 'smooth'
          });
          
          // 更新 URL（不触发滚动）
          history.pushState(null, '', `#${heading.id}`);
        }
      });
      
      li.appendChild(link);
      tocList.appendChild(li);
    });
    
    tocNav.innerHTML = '';
    tocNav.appendChild(tocList);
    
    // 初始化滚动监听
    initScrollSpy();
  }

  // 滚动监听，高亮当前可见的标题
  function initScrollSpy() {
    const headings = document.querySelectorAll('.tutorial-content h2, .tutorial-content h3');
    const tocLinks = document.querySelectorAll('.toc-nav .toc-link');
    
    if (headings.length === 0 || tocLinks.length === 0) return;

    let ticking = false;

    function onScroll() {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          updateActiveLink();
          ticking = false;
        });
        ticking = true;
      }
    }

    function updateActiveLink() {
      const scrollPosition = window.scrollY + 100;
      
      let currentHeading = null;
      
      // 找到当前可见的标题
      headings.forEach((heading) => {
        const top = heading.offsetTop;
        if (scrollPosition >= top) {
          currentHeading = heading;
        }
      });
      
      // 更新高亮
      tocLinks.forEach((link) => {
        link.classList.remove('active');
        
        if (currentHeading && link.getAttribute('data-target') === currentHeading.id) {
          link.classList.add('active');
          // 激活状态样式
          link.style.color = '#60a5fa';
          link.style.borderLeftColor = '#60a5fa';
          link.style.fontWeight = '500';
        } else {
          // 恢复默认状态样式
          link.style.borderLeftColor = 'transparent';
          link.style.fontWeight = 'normal';
          if (link.classList.contains('toc-h3')) {
            link.style.color = 'rgba(156, 163, 175, 0.8)';
          } else {
            link.style.color = 'rgba(156, 163, 175, 0.9)';
          }
        }
      });
    }

    window.addEventListener('scroll', onScroll, { passive: true });
    
    // 初始化时执行一次
    updateActiveLink();
  }

  // 页面加载时生成目录（延迟执行确保 DOM 完全加载）
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(generateTOC, 150);
    });
  } else {
    setTimeout(generateTOC, 150);
  }

  // 监听页面导航
  document.addEventListener('astro:page-load', () => {
    setTimeout(generateTOC, 150);
  });
</script>
